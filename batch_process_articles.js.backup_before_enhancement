#!/usr/bin/env node

const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');
const ArticleRewriterEnhanced = require('./article_rewriter_enhanced');
const ImageProcessorFinal = require('./image_processor_final');
const WebsiteDuplicateChecker = require('./website_duplicate_checker');
const APIFailureHandler = require('./api_failure_handler');

class BatchArticleProcessor {
    constructor() {
        this.browser = null;
        this.dateStr = new Date().toISOString().split('T')[0];
        this.baseDir = path.join(process.cwd(), 'golf_content', this.dateStr);
        this.rewriter = new ArticleRewriterEnhanced();
        this.imageProcessor = new ImageProcessorFinal(this.baseDir);
        this.apiFailureHandler = new APIFailureHandler();
        this.ensureDirectories();
        
        // Âä†ËΩΩÁΩëÁ´ôÈÖçÁΩÆ
        try {
            this.websiteConfigs = JSON.parse(fs.readFileSync(path.join(__dirname, 'website_configs.json'), 'utf8'));
        } catch (e) {
            // Â¶ÇÊûúÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ
            this.websiteConfigs = {
                'golfmonthly.com': {
                    selectors: {
                        title: 'h1',
                        article: 'article',
                        content: 'p, h2, h3',
                        heroImage: '.image-hero__padding img, article img:first-of-type',
                        contentImages: 'figure img'
                    }
                }
            };
        }
    }

    ensureDirectories() {
        ['images', 'wechat_ready', 'wechat_html'].forEach(dir => {
            const fullPath = path.join(this.baseDir, dir);
            if (!fs.existsSync(fullPath)) {
                fs.mkdirSync(fullPath, { recursive: true });
            }
        });
    }
    
    getWebsiteConfig(url) {
        try {
            const urlObj = new URL(url);
            const domain = urlObj.hostname.replace('www.', '');
            return this.websiteConfigs[domain] || this.websiteConfigs['golfmonthly.com'];
        } catch (e) {
            return this.websiteConfigs['golfmonthly.com'];
        }
    }

    // üîß ‰øÆÊîπ1: Â¢ûÂº∫ÁöÑËé∑Âèñ‰∏ã‰∏Ä‰∏™ÊñáÁ´†ÁºñÂè∑ÊñπÊ≥ï - Èò≤Ê≠¢ÂõæÁâáË¶ÜÁõñ
    getNextArticleNumber() {
        const wechatDir = path.join(this.baseDir, 'wechat_ready');
        const urlMapFile = path.join(this.baseDir, 'article_urls.json');
        let maxNum = 0;
        
        // Ê£ÄÊü•markdownÊñá‰ª∂ÁºñÂè∑
        if (fs.existsSync(wechatDir)) {
            const files = fs.readdirSync(wechatDir)
                .filter(f => f.match(/wechat_article_(\d+)\.md/))
                .map(f => parseInt(f.match(/wechat_article_(\d+)\.md/)[1]));
            if (files.length > 0) {
                maxNum = Math.max(...files);
            }
        }
        
        // Ê£ÄÊü•URLÊò†Â∞Ñ‰∏≠ÁöÑÁºñÂè∑
        if (fs.existsSync(urlMapFile)) {
            try {
                const urlMapping = JSON.parse(fs.readFileSync(urlMapFile, 'utf8'));
                const nums = Object.keys(urlMapping).map(n => parseInt(n));
                if (nums.length > 0) {
                    maxNum = Math.max(maxNum, ...nums);
                }
            } catch (err) {}
        }
        
        // È¢ùÂ§ñÊ£ÄÊü•ÂõæÁâáÊñá‰ª∂Â§π‰∏≠ÁöÑÁºñÂè∑
        const imagesDir = path.join(this.baseDir, 'images');
        if (fs.existsSync(imagesDir)) {
            const imageFiles = fs.readdirSync(imagesDir)
                .filter(f => f.match(/article_(\d+)_img_/))
                .map(f => parseInt(f.match(/article_(\d+)_img_/)[1]));
            if (imageFiles.length > 0) {
                maxNum = Math.max(maxNum, ...imageFiles);
            }
        }
        
        return String(maxNum + 1).padStart(2, '0');
    }

    // üîß ‰øÆÊîπ2: Â¢ûÂº∫ClaudeËæìÂá∫È™åËØÅ
    validateClaudeOutput(stdout) {
        // È™åËØÅËæìÂá∫ÊòØÂê¶ÂåÖÂê´‰∏≠Êñá
        const hasChineseChars = /[\u4e00-\u9fa5]/.test(stdout);
        if (!hasChineseChars) {
            throw new Error('ÊîπÂÜôÁªìÊûú‰∏çÂåÖÂê´‰∏≠ÊñáÂÜÖÂÆπ');
        }
        
        // È™åËØÅÊòØÂê¶ÊúâÊ†áÈ¢òÔºà‰ª•#ÂºÄÂ§¥Ôºâ
        const hasTitle = /^#\s+.+/m.test(stdout.trim());
        if (!hasTitle) {
            throw new Error('ÊîπÂÜôÁªìÊûúÁº∫Â∞ëÊ†áÈ¢òÔºàÂ∫î‰ª•#ÂºÄÂ§¥Ôºâ');
        }
        
        return true;
    }

    async processArticles(urls) {
        console.log('üöÄ ÊâπÈáèÂ§ÑÁêÜÊñáÁ´†ÔºàÁªàÊûÅ‰ºòÂåñÁâàÔºâ');
        
        // 1. È¶ñÂÖàËøõË°åÂÖ®Â±ÄÂéªÈáçÊ£ÄÊµã
        console.log('1Ô∏è‚É£ ÂÖ®Â±ÄÂéªÈáçÊ£ÄÊµã...\n');
        const duplicateChecker = new WebsiteDuplicateChecker();
        const { newUrls, duplicateUrls } = duplicateChecker.displayResults(urls);
        
        if (newUrls.length === 0) {
            console.log('‚úÖ ÊâÄÊúâÊñáÁ´†ÈÉΩÂ∑≤Â§ÑÁêÜËøáÔºåÊó†ÈúÄÈáçÂ§çÂ§ÑÁêÜ');
            console.log('üëã Á®ãÂ∫èÈÄÄÂá∫');
            return;
        }
        
        // Âè™Â§ÑÁêÜÊñ∞ÊñáÁ´†
        urls = newUrls;
        console.log(`üìä ÂºÄÂßãÂ§ÑÁêÜ ${urls.length} ÁØáÊñ∞ÊñáÁ´†\n`);
        
        const totalStart = Date.now();
        
        // 2. ÂêØÂä®ÊµèËßàÂô®
        console.log('2Ô∏è‚É£ ÂêØÂä®ÊµèËßàÂô®...');
        this.browser = await chromium.launch({
            headless: true,
            executablePath: '/Users/sanshui/Library/Caches/ms-playwright/chromium-1181/chrome-mac/Chromium.app/Contents/MacOS/Chromium',
            args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu']
        });
        
        // 3. Âπ∂Ë°åÊäìÂèñÊâÄÊúâÊñáÁ´†
        console.log('3Ô∏è‚É£ Âπ∂Ë°åÊäìÂèñÊñáÁ´†ÂíåÂõæÁâá...');
        const extractStart = Date.now();
        
        const articles = await Promise.all(urls.map(async (url, index) => {
            const page = await this.browser.newPage();
            
            // Â§ÑÁêÜÁâπÂÆöÁΩëÁ´ôÁöÑ cookies
            if (url.includes('mygolfspy.com')) {
                try {
                    const cookieFile = path.join(__dirname, 'cookies', 'mygolfspy_cookies.json');
                    const cookieData = fs.readFileSync(cookieFile, 'utf8');
                    const cookies = JSON.parse(cookieData);
                    await page.context().addCookies(cookies);
                } catch (e) {
                    // ÂøΩÁï• cookie Âä†ËΩΩÈîôËØØ
                }
            }
            
            try {
                // Ëé∑ÂèñÁΩëÁ´ôÈÖçÁΩÆ
                const siteConfig = this.getWebsiteConfig(url);
                const selectors = siteConfig.selectors;
                
                await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 30000 });
                
                // Â§ÑÁêÜ MyGolfSpy ÂºπÁ™ó
                if (url.includes('mygolfspy.com')) {
                    await page.waitForTimeout(2000);
                    const popupSelectors = [
                        'button[aria-label*="close"]', 'button.close', '.close-button',
                        '[class*="close"]', 'text=√ó', 'text=X'
                    ];
                    for (const selector of popupSelectors) {
                        try {
                            const closeBtn = await page.locator(selector).first();
                            if (await closeBtn.isVisible({ timeout: 500 })) {
                                await closeBtn.click();
                                await page.waitForTimeout(1000);
                                break;
                            }
                        } catch (e) {}
                    }
                }
                
                // Á≠âÂæÖÊñáÁ´†ÂÆπÂô®
                try {
                    await page.waitForSelector(selectors.article || 'article', { timeout: 5000 });
                } catch (e) {
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞articleÊ†áÁ≠æÔºåÂ∞ùËØïÁ≠âÂæÖÊ†áÈ¢ò
                    await page.waitForSelector(selectors.title || 'h1', { timeout: 5000 });
                }
                
                // Âø´ÈÄüÊèêÂèñ
                const data = await page.evaluate((selectors) => {
                    const title = document.querySelector(selectors.title)?.innerText || '';
                    const article = document.querySelector(selectors.article);
                    
                    // Â¶ÇÊûúÊ≤°ÊúâarticleÂÆπÂô®Ôºå‰ΩøÁî®bodyÊàñmain
                    const contentContainer = article || document.querySelector('main') || document.body;
                    if (!contentContainer) return null;
                    
                    const images = [];
                    let content = `# ${title}\n\n`;
                    
                    // Ëé∑ÂèñÊâÄÊúâÂÜÖÂÆπÂÖÉÁ¥†ÔºàÊÆµËêΩ„ÄÅÊ†áÈ¢ò„ÄÅÂõæÁâáÁ≠âÔºâ
                    const allElements = contentContainer.querySelectorAll('p, h2, h3, img, figure');
                    let imageCounter = 0;
                    
                    allElements.forEach(element => {
                        if (element.tagName === 'P') {
                            const text = element.innerText.trim();
                            if (text.length > 20) {
                                content += `${text}\n\n`;
                            }
                        }
                        else if (element.tagName === 'H2') {
                            const text = element.innerText.trim();
                            if (text) content += `\n## ${text}\n\n`;
                        }
                        else if (element.tagName === 'H3') {
                            const text = element.innerText.trim();
                            if (text) content += `\n### ${text}\n\n`;
                        }
                        else if (element.tagName === 'IMG' || element.tagName === 'FIGURE') {
                            // Â§ÑÁêÜÂõæÁâá
                            const img = element.tagName === 'FIGURE' ? element.querySelector('img') : element;
                            if (img && img.src && 
                                !img.closest('a') && 
                                !img.classList.contains('thumbnail') &&
                                !img.classList.contains('thumb') &&
                                img.width > 200) {
                                imageCounter++;
                                let alt = img.alt || element.querySelector('figcaption')?.innerText || `ÂõæÁâá${imageCounter}`;
                                // Â¶ÇÊûúÊòØËã±ÊñáËØ¥ÊòéÔºå‰øùÊåÅÂéüÊ†∑ÔºàËÆ©ClaudeÊù•ÁøªËØëÔºâ
                                images.push({ url: img.src, alt: alt });
                                // Âú®Âéü‰ΩçÁΩÆÊèíÂÖ•ÂõæÁâáÂç†‰ΩçÁ¨¶
                                content += `[IMAGE_${imageCounter}:${alt}]\n\n`;
                            }
                        }
                    });
                    
                    return { title, content, images };
                }, selectors);
                
                // ‰ΩøÁî®Â∞ÅË£ÖÁöÑÂõæÁâáÂ§ÑÁêÜÂô®‰∏ãËΩΩÂõæÁâá
                // ÂÖà‰∏¥Êó∂‰ΩøÁî®Á¥¢ÂºïÔºåÁ®çÂêé‰ºöÂàÜÈÖçÂÆûÈôÖÁºñÂè∑
                const tempNum = String(index + 1).padStart(2, '0');
                data.images = await this.imageProcessor.downloadImages(this.browser, data.images, tempNum);
                
                console.log(`  ‚úÖ ÊñáÁ´†${tempNum} ÊäìÂèñÂÆåÊàê (${data.images.length}Âº†ÂõæÁâá)`);
                
                return {
                    ...data,
                    url,
                    tempNum,  // ‰∏¥Êó∂ÁºñÂè∑
                    images: data.images
                };
                
            } finally {
                await page.close();
            }
        }));
        
        console.log(`‚úÖ ÊäìÂèñÂÆåÊàê (${Date.now() - extractStart}ms)\n`);
        
        // ‰∏∫ÊØèÁØáÊñáÁ´†ÂàÜÈÖçÂÆûÈôÖÁºñÂè∑
        let currentNum = parseInt(this.getNextArticleNumber());
        articles.forEach(article => {
            article.articleNum = String(currentNum++).padStart(2, '0');
            // Êõ¥Êñ∞ÂõæÁâáÊñá‰ª∂Âêç
            article.images.forEach((img, idx) => {
                if (img.filename) {
                    const oldFilename = img.filename;
                    const newFilename = `article_${article.articleNum}_img_${idx + 1}.jpg`;
                    const oldPath = path.join(this.baseDir, 'images', oldFilename);
                    const newPath = path.join(this.baseDir, 'images', newFilename);
                    
                    if (fs.existsSync(oldPath) && oldPath !== newPath) {
                        fs.renameSync(oldPath, newPath);
                        img.filename = newFilename;
                    }
                }
            });
        });
        
        // 4. ‰ΩøÁî®Â∞ÅË£ÖÁöÑClaudeÊîπÂÜôÂô®Ôºà‰∏ÄÁØá‰∏ÄÁØáÂ§ÑÁêÜÔºâ
        console.log('4Ô∏è‚É£ ClaudeÊîπÂÜôÔºàÈÄêÁØáÂ§ÑÁêÜÔºâ...');
        const rewriteStart = Date.now();
        
        for (let i = 0; i < articles.length; i++) {
            const article = articles[i];
            console.log(`\n  üìù Ê≠£Âú®ÊîπÂÜôÁ¨¨ ${i + 1}/${articles.length} ÁØáÊñáÁ´†...`);
            console.log(`     Ê†áÈ¢ò: ${article.title.substring(0, 50)}...`);
            
            try {
                const articleStart = Date.now();
                const rewrittenContent = await this.rewriter.rewriteArticle(article.title, article.content);
                
                // üîß ‰øÆÊîπ4: ‰ΩøÁî®Â¢ûÂº∫ÁöÑÈ™åËØÅ
                this.validateClaudeOutput(rewrittenContent);
                
                article.rewrittenContent = rewrittenContent;
                
                const timeTaken = Math.round((Date.now() - articleStart) / 1000);
                console.log(`  ‚úÖ ÊñáÁ´†${article.articleNum} ÊîπÂÜôÂÆåÊàê (ËÄóÊó∂: ${timeTaken}Áßí)`);
                console.log(`  üìù ËæìÂá∫ÈïøÂ∫¶: ${rewrittenContent.length} Â≠óÁ¨¶`);
                console.log(`  üî§ Ââç50Â≠óÁ¨¶: ${rewrittenContent.substring(0, 50)}...`);
                
                // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰∏≠Êñá
                const hasChineseChars = /[\u4e00-\u9fa5]/.test(rewrittenContent);
                if (!hasChineseChars) {
                    console.log(`  ‚ö†Ô∏è Ë≠¶ÂëäÔºöËæìÂá∫‰∏çÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶ÔºÅ`);
                }
                
                // ÊØèÁØáÊñáÁ´†ÊîπÂÜôÂêéÁ≠âÂæÖ2ÁßíÔºåÈÅøÂÖçAPIÂéãÂäõ
                if (i < articles.length - 1) {
                    console.log(`  ‚è≥ Á≠âÂæÖ2ÁßíÂêéÂ§ÑÁêÜ‰∏ã‰∏ÄÁØá...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
            } catch (err) {
                console.error(`  ‚ùå ÊñáÁ´†${article.articleNum} ÊîπÂÜôÂ§±Ë¥•:`, err.message);
                console.error('  Ë∑≥ËøáÊ≠§ÊñáÁ´†ÔºåÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏ÄÁØá');
                article.rewrittenContent = null; // Ê†áËÆ∞‰∏∫Â§±Ë¥•
                
                // ËÆ∞ÂΩïÂ§±Ë¥•ÁöÑÊñáÁ´†
                this.apiFailureHandler.logFailedArticle(article.url, err.message);
            }
        }
        
        console.log(`‚úÖ ÊîπÂÜôÂÆåÊàê (${Date.now() - rewriteStart}ms)\n`);
        
        // 5. ‰øùÂ≠òÊñá‰ª∂
        console.log('5Ô∏è‚É£ ‰øùÂ≠òÊñá‰ª∂...');
        const saveStart = Date.now();
        
        // ËøáÊª§ÊéâÊîπÂÜôÂ§±Ë¥•ÁöÑÊñáÁ´†
        const successArticles = articles.filter(a => a.rewrittenContent !== null);
        if (successArticles.length < articles.length) {
            console.log(`‚ö†Ô∏è ${articles.length - successArticles.length} ÁØáÊñáÁ´†ÊîπÂÜôÂ§±Ë¥•ÔºåÂ∑≤Ë∑≥Ëøá`);
        }
        
        await Promise.all(successArticles.map(async article => {
            const num = article.articleNum;
            let content = article.rewrittenContent;
            
            // ‰ΩøÁî®Â∞ÅË£ÖÁöÑÂõæÁâáÂ§ÑÁêÜÂô®ÊõøÊç¢Âç†‰ΩçÁ¨¶
            console.log(`  üì∏ ÊñáÁ´†${num}Êúâ ${article.images.length} Âº†ÂõæÁâá`);
            content = this.imageProcessor.replaceImagePlaceholders(content, article.images);
            
            // Ê∑ªÂä†Â∫ïÈÉ®
            if (!content.includes('Êü•ÁúãÂéüÊñá')) {
                content += `\n\n---\n\n[Êü•ÁúãÂéüÊñá](${article.url})`;
            }
            
            // ‰øùÂ≠ò
            const mdFile = path.join(this.baseDir, 'wechat_ready', `wechat_article_${num}.md`);
            const htmlFile = path.join(this.baseDir, 'wechat_html', `wechat_article_${num}.html`);
            
            fs.writeFileSync(mdFile, content, 'utf8');
            fs.writeFileSync(htmlFile, this.generateHTML(article.title, content), 'utf8');
        }));
        
        // Êõ¥Êñ∞URLÊò†Â∞ÑÔºàÂêàÂπ∂Áé∞ÊúâÁöÑÔºâ
        const urlMapFile = path.join(this.baseDir, 'article_urls.json');
        let urlMapping = {};
        
        // ÂÖàËØªÂèñÁé∞ÊúâÁöÑÊò†Â∞Ñ
        if (fs.existsSync(urlMapFile)) {
            try {
                urlMapping = JSON.parse(fs.readFileSync(urlMapFile, 'utf8'));
            } catch (err) {
                console.log('‚ö†Ô∏è ËØªÂèñÁé∞ÊúâURLÊò†Â∞ÑÂ§±Ë¥•ÔºåÂàõÂª∫Êñ∞ÁöÑ');
            }
        }
        
        // Ê∑ªÂä†Êñ∞ÁöÑÊò†Â∞Ñ
        successArticles.forEach(a => {
            urlMapping[a.articleNum] = a.url;
            // Ê†áËÆ∞ÊàêÂäüÁöÑÊñáÁ´†
            this.apiFailureHandler.markAsSuccess(a.url);
        });
        
        fs.writeFileSync(urlMapFile, JSON.stringify(urlMapping, null, 2), 'utf8');
        
        console.log(`‚úÖ ‰øùÂ≠òÂÆåÊàê (${Date.now() - saveStart}ms)\n`);
        
        // ÂÆåÊàê
        await this.browser.close();
        
        const totalTime = Date.now() - totalStart;
        console.log('='.repeat(50));
        console.log('‚ú® ÊâπÈáèÂ§ÑÁêÜÂÆåÊàêÔºÅ');
        console.log(`üìä Â§ÑÁêÜÁªüËÆ°:`);
        console.log(`   - ËæìÂÖ•ÊñáÁ´†Êï∞: ${urls.length + duplicateUrls.length}`);
        console.log(`   - Ë∑≥ËøáÈáçÂ§ç: ${duplicateUrls.length}`);
        console.log(`   - ÂÆûÈôÖÂ§ÑÁêÜ: ${urls.length}`);
        console.log(`   - ÊàêÂäüÂÆåÊàê: ${successArticles.length}`);
        console.log(`‚è±Ô∏è ÊÄªËÄóÊó∂: ${Math.round(totalTime / 1000)}Áßí`);
        console.log(`üìà Âπ≥ÂùáÊØèÁØá: ${Math.round(totalTime / articles.length / 1000)}Áßí`);
        console.log('\nüì± ËÆøÈóÆ http://localhost:8080 Êü•ÁúãÂÜÖÂÆπ');
    }

    generateHTML(title, content) {
        // ÂÖàÂ§ÑÁêÜÂõæÁâáÔºåÈÅøÂÖçË¢´ÊÆµËêΩÊ†áÁ≠æÂåÖË£π
        let imageCounter = 1;
        let htmlContent = content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
            const caption = alt || `ÂõæÁâá${imageCounter}`;
            imageCounter++;
            // Â∞ÜÁõ∏ÂØπË∑ØÂæÑËΩ¨Êç¢‰∏∫ÁªùÂØπË∑ØÂæÑ
            const absoluteSrc = src.replace('../images/', `/golf_content/${this.dateStr}/images/`);
            return `<div class="image-container">
                        <img src="${absoluteSrc}" alt="${caption}" class="article-image" onclick="copyImage(this)">
                    </div>`;
        });
        
        // ÁÑ∂ÂêéÂ§ÑÁêÜÂÖ∂‰ªñMarkdownÂÖÉÁ¥†
        htmlContent = htmlContent
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            // Â§ÑÁêÜ"Êü•ÁúãÂéüÊñá"ÈìæÊé•
            .replace(/\[Êü•ÁúãÂéüÊñá\]\(([^)]+)\)/g, '<a href="$1" target="_blank">Êü•ÁúãÂéüÊñá</a>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/^/, '<p>').replace(/$/, '</p>');
        
        // ÂÆåÊï¥ÁöÑHTMLÊ®°Êùø
        return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.8;
            background: white;
            color: #333;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0 0 30px 0;
            color: #333;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
        }
        
        h2 {
            font-size: 1.3rem;
            color: #444;
            margin: 30px 0 15px 0;
            font-weight: 600;
        }
        
        h3 {
            font-size: 1.1rem;
            color: #555;
            margin: 25px 0 10px 0;
            font-weight: 600;
        }
        
        p {
            margin: 15px 0;
            font-size: 15px;
            line-height: 1.8;
        }
        
        strong {
            color: #d32f2f;
            font-weight: 600;
        }
        
        .image-container {
            margin: 30px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-container:hover {
            transform: translateY(-2px);
        }
        
        .article-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .article-image:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .image-caption {
            margin: 15px 0 0 0;
            font-size: 14px;
            color: #666;
            font-style: italic;
            text-align: center;
        }
        
        .toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #1565c0;
        }
        
        .copy-success {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
            font-weight: bold;
        }
        
        .copy-success.show {
            opacity: 1;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
                font-size: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .toolbar {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="btn" onclick="copyToWechat()" style="background: #07c160;">üìã Â§çÂà∂Âà∞ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑</button>
        <button class="btn" onclick="copyAllContent()">üìã Â§çÂà∂ÂÖ®Êñá</button>
        <button class="btn" onclick="copyOnlyText()">üìù ‰ªÖÂ§çÂà∂ÊñáÂ≠ó</button>
    </div>
    
    ${htmlContent}
    
    <div class="copy-success" id="copySuccess">‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ</div>
    
    <script>
        // Â§çÂà∂ÂõæÁâáÂäüËÉΩ
        async function copyImage(img) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showCopySuccess('ÂõæÁâáÂ∑≤Â§çÂà∂ÔºÅ');
                    } catch (err) {
                        fallbackCopyImage(img);
                    }
                }, 'image/png');
                
            } catch (err) {
                fallbackCopyImage(img);
            }
        }
        
        // Â§áÁî®Â§çÂà∂ÊñπÊ≥ï
        function fallbackCopyImage(img) {
            const range = document.createRange();
            range.selectNode(img);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                showCopySuccess('ÂõæÁâáÂ∑≤Â§çÂà∂ÔºÅ');
            } catch (err) {
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑Âè≥ÈîÆÈÄâÊã©"Â§çÂà∂ÂõæÂÉè"');
            }
            
            window.getSelection().removeAllRanges();
        }
        
        // ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑‰∏ìÁî®Â§çÂà∂ÂäüËÉΩ
        function copyToWechat() {
            console.log('ÂºÄÂßãÂ§çÂà∂Âà∞ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑...');
            
            try {
                // ÂàõÂª∫Â§çÂà∂ÂÆπÂô®
                const copyContainer = document.createElement('div');
                copyContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 800px; background: white;';
                document.body.appendChild(copyContainer);
                
                // Ëé∑ÂèñÊâÄÊúâÂÜÖÂÆπÂÖÉÁ¥†ÔºàÊéíÈô§Â∑•ÂÖ∑Ê†èÁ≠âÔºâ
                const allElements = document.querySelectorAll('h1, h2, h3, h4, p, div.image-container, .content img');
                console.log('ÊâæÂà∞ÂÖÉÁ¥†Êï∞Èáè:', allElements.length);
                
                allElements.forEach((el, index) => {
                    // Ë∑≥ËøáÂ∑•ÂÖ∑Ê†èÂíå‰∏çÈúÄË¶ÅÁöÑÂÖÉÁ¥†
                    if (el.innerHTML && (
                        el.innerHTML.includes('Â§çÂà∂') || 
                        el.innerHTML.includes('Â∑•ÂÖ∑') || 
                        el.innerHTML.includes('toolbar') ||
                        el.closest('.toolbar')
                    )) {
                        return;
                    }
                    
                    if (el.tagName === 'H1') {
                        // Ê†áÈ¢òÂ§ÑÁêÜ
                        const p = document.createElement('p');
                        p.style.cssText = 'margin: 0 0 20px 0; padding: 0; text-align: center; font-size: 0;';
                        const span = document.createElement('span');
                        span.style.cssText = 'font-size: 22px; font-weight: bold; color: #333333; line-height: 1.5;';
                        span.textContent = el.textContent.trim();
                        p.appendChild(span);
                        copyContainer.appendChild(p);
                        
                    } else if (el.tagName === 'H2') {
                        // ‰∫åÁ∫ßÊ†áÈ¢ò
                        const p = document.createElement('p');
                        p.style.cssText = 'margin: 25px 0 15px 0; padding: 0; font-size: 0;';
                        const span = document.createElement('span');
                        span.style.cssText = 'font-size: 18px; font-weight: bold; color: #333333; line-height: 1.5;';
                        span.textContent = el.textContent.trim();
                        p.appendChild(span);
                        copyContainer.appendChild(p);
                        
                    } else if (el.tagName === 'H3') {
                        // ‰∏âÁ∫ßÊ†áÈ¢ò
                        const p = document.createElement('p');
                        p.style.cssText = 'margin: 20px 0 10px 0; padding: 0; font-size: 0;';
                        const span = document.createElement('span');
                        span.style.cssText = 'font-size: 16px; font-weight: bold; color: #333333; line-height: 1.5;';
                        span.textContent = el.textContent.trim();
                        p.appendChild(span);
                        copyContainer.appendChild(p);
                        
                    } else if (el.tagName === 'P') {
                        // ÊÆµËêΩÂ§ÑÁêÜ
                        const p = document.createElement('p');
                        p.style.cssText = 'margin: 15px 0; padding: 0; font-size: 0; line-height: 1.8;';
                        
                        // Â§ÑÁêÜÊÆµËêΩÂÜÖÂÆπÔºå‰øùÊåÅÊ†ºÂºè
                        let htmlContent = el.innerHTML;
                        
                        // Â§ÑÁêÜÁ≤ó‰Ωì
                        htmlContent = htmlContent.replace(/<strong[^>]*>/g, '<span style="font-weight: bold;">');
                        htmlContent = htmlContent.replace(/<\/strong>/g, '</span>');
                        htmlContent = htmlContent.replace(/<b[^>]*>/g, '<span style="font-weight: bold;">');
                        htmlContent = htmlContent.replace(/<\/b>/g, '</span>');
                        
                        // ÂàõÂª∫‰∏¥Êó∂ÂÆπÂô®Ëß£ÊûêHTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        
                        // ÈÄíÂΩíÂ§ÑÁêÜÊâÄÊúâËäÇÁÇπ
                        function processNode(node, parentElement) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                if (node.textContent.trim()) {
                                    const span = document.createElement('span');
                                    span.style.cssText = 'font-size: 15px; color: #333333;';
                                    span.textContent = node.textContent;
                                    parentElement.appendChild(span);
                                }
                            } else if (node.nodeType === Node.ELEMENT_NODE) {
                                if (node.tagName === 'SPAN') {
                                    const span = document.createElement('span');
                                    span.style.cssText = 'font-size: 15px; color: #333333;' + (node.style.fontWeight === 'bold' ? ' font-weight: bold;' : '');
                                    span.textContent = node.textContent;
                                    parentElement.appendChild(span);
                                } else {
                                    // Â§ÑÁêÜÂÖ∂‰ªñÊ†áÁ≠æ
                                    node.childNodes.forEach(child => processNode(child, parentElement));
                                }
                            }
                        }
                        
                        tempDiv.childNodes.forEach(node => processNode(node, p));
                        copyContainer.appendChild(p);
                        
                    } else if ((el.classList && el.classList.contains('image-container')) || el.tagName === 'IMG') {
                        // ÂõæÁâáÂ§ÑÁêÜ - Ê∑ªÂä†Âç†‰ΩçÊñáÊú¨
                        const img = el.tagName === 'IMG' ? el : el.querySelector('img');
                        if (img) {
                            const p = document.createElement('p');
                            p.style.cssText = 'margin: 25px 0; padding: 15px; background-color: #f5f5f5; border: 2px dashed #ccc; text-align: center; font-size: 0;';
                            
                            const span = document.createElement('span');
                            span.style.cssText = 'font-size: 14px; color: #666666; display: block;';
                            span.textContent = '[ÂõæÁâáÂç†‰ΩçÔºö' + (img.alt || 'ËØ∑ÊâãÂä®‰∏ä‰º†ÂõæÁâá') + ']';
                            p.appendChild(span);
                            
                            // Ê∑ªÂä†ÂõæÁâá‰ø°ÊÅØ
                            if (img.src) {
                                const urlSpan = document.createElement('span');
                                urlSpan.style.cssText = 'font-size: 12px; color: #999999; display: block; margin-top: 5px; word-break: break-all;';
                                urlSpan.textContent = 'ÂõæÁâáË∑ØÂæÑ: ' + img.src;
                                p.appendChild(urlSpan);
                            }
                            
                            copyContainer.appendChild(p);
                        }
                    }
                });
                
                console.log('Â§ÑÁêÜÂÆåÊàêÔºåÂºÄÂßãÂ§çÂà∂...');
                
                // ÈÄâÊã©ÂÜÖÂÆπËøõË°åÂ§çÂà∂
                const range = document.createRange();
                range.selectNodeContents(copyContainer);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // ÊâßË°åÂ§çÂà∂
                let success = false;
                
                // ÊñπÊ≥ï1: ‰ΩøÁî® execCommand
                try {
                    success = document.execCommand('copy');
                    console.log('execCommand Â§çÂà∂ÁªìÊûú:', success);
                } catch (e) {
                    console.log('execCommand Â§±Ë¥•:', e);
                }
                
                // ÊñπÊ≥ï2: ‰ΩøÁî®Áé∞‰ª£ Clipboard APIÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                if (!success && navigator.clipboard) {
                    try {
                        const htmlContent = copyContainer.innerHTML;
                        const textContent = copyContainer.textContent;
                        
                        // ÂàõÂª∫ ClipboardItem
                        const clipboardItem = new ClipboardItem({
                            'text/html': new Blob([htmlContent], { type: 'text/html' }),
                            'text/plain': new Blob([textContent], { type: 'text/plain' })
                        });
                        
                        navigator.clipboard.write([clipboardItem]).then(() => {
                            console.log('Clipboard API Â§çÂà∂ÊàêÂäü');
                            success = true;
                            showCopyResult(true);
                        }).catch(err => {
                            console.log('Clipboard API Â§±Ë¥•:', err);
                            showCopyResult(false);
                        });
                    } catch (e) {
                        console.log('Clipboard API ÂàõÂª∫Â§±Ë¥•:', e);
                    }
                }
                
                // Ê∏ÖÁêÜ
                selection.removeAllRanges();
                setTimeout(() => {
                    if (document.body.contains(copyContainer)) {
                        document.body.removeChild(copyContainer);
                    }
                }, 100);
                
                // ÊòæÁ§∫ÁªìÊûú
                if (success) {
                    showCopyResult(true);
                } else {
                    showCopyResult(false);
                }
                
            } catch (error) {
                console.error('Â§çÂà∂ËøáÁ®ãÂá∫Èîô:', error);
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ');
            }
        }

        // ÊòæÁ§∫Â§çÂà∂ÁªìÊûú
        function showCopyResult(success) {
            const message = success ? 
                '‚úÖ Â§çÂà∂ÊàêÂäüÔºÅ\\n\\nÊ≥®ÊÑè‰∫ãÈ°πÔºö\\n1. ÊñáÂ≠óÊ†ºÂºèÂ∑≤‰ºòÂåñ‰∏∫15px\\n2. ÂõæÁâáÊòæÁ§∫‰∏∫Âç†‰ΩçÁ¨¶ÔºåÈúÄË¶ÅÊâãÂä®‰∏ä‰º†\\n3. ËØ∑Âú®ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑ÁºñËæëÂô®‰∏≠Á≤òË¥¥' :
                '‚ùå Â§çÂà∂Â§±Ë¥•ÔºÅ\\n\\nÂèØËÉΩÂéüÂõ†Ôºö\\n1. ÊµèËßàÂô®‰∏çÊîØÊåÅÂ§çÂà∂ÂäüËÉΩ\\n2. ÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÊâçËÉΩÂ§çÂà∂\\n3. ËØ∑Â∞ùËØïÊâãÂä®ÈÄâÊã©Â§çÂà∂';
            
            alert(message);
        }

        // ÁÆÄÂåñÁöÑÂ§çÂà∂ÂäüËÉΩÔºàÂü∫Á°ÄÂ§çÂà∂Ôºâ
        function copyAllContent() {
            try {
                // ÁÆÄÂçïÂ§çÂà∂È°µÈù¢ÊñáÂ≠óÂÜÖÂÆπÔºå‰∏çÂåÖÂê´ÂõæÁâá
                let textContent = document.body.innerText;
                
                // Ê∏ÖÁêÜÊñáÊú¨ÂÜÖÂÆπ
                textContent = textContent
                    .replace(/üìã.*?üìù ‰ªÖÂ§çÂà∂ÊñáÂ≠ó/g, '')
                    .replace(/‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ/g, '')
                    .replace(/Êü•ÁúãÂéüÊñá/g, '')
                    .replace(/---/g, '')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
                
                // ‰ΩøÁî®ÁÆÄÂçïÁöÑÂ§çÂà∂ÊñπÊ≥ï
                navigator.clipboard.writeText(textContent).then(() => {
                    showCopySuccess('ÊñáÂ≠óÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
                }).catch(() => {
                    // Â§áÁî®ÊñπÊ≥ï
                    const textarea = document.createElement('textarea');
                    textarea.value = textContent;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showCopySuccess('ÊñáÂ≠óÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
                });
            } catch (error) {
                console.error('copyAllContent ÂáΩÊï∞Âá∫Èîô:', error);
                alert('Â§çÂà∂Âá∫ÈîôÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞');
            }
        }
        
        // Â§çÂà∂Á∫ØÊñáÂ≠óÂÜÖÂÆπ
        function copyOnlyText() {
            let textContent = document.body.innerText;
            
            // Ê∏ÖÁêÜÊñáÊú¨ÂÜÖÂÆπ
            textContent = textContent
                .replace(/üìã Â§çÂà∂ÂÖ®Êñá\\s*üìù ‰ªÖÂ§çÂà∂ÊñáÂ≠ó/g, '')
                .replace(/‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ/g, '')
                .replace(/\\n{3,}/g, '\\n\\n')
                .trim();
            
            navigator.clipboard.writeText(textContent).then(() => {
                showCopySuccess('ÊñáÂ≠óÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
            }).catch(() => {
                // Â§áÁî®ÊñπÊ≥ï
                const textarea = document.createElement('textarea');
                textarea.value = textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopySuccess('ÊñáÂ≠óÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
            });
        }
        
        // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊèêÁ§∫
        function showCopySuccess(message) {
            const successDiv = document.getElementById('copySuccess');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 2000);
        }
        
        // ÂõæÁâáÂä†ËΩΩÈîôËØØÂ§ÑÁêÜ
        document.querySelectorAll('.article-image').forEach(img => {
            img.onerror = function() {
                this.style.display = 'none';
                this.parentElement.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</p>';
            };
        });
    </script>
</body>
</html>`;
    }
}

// ÂëΩ‰ª§Ë°åÊâßË°å
if (require.main === module) {
    const urls = [
        'https://example.com/article1',
        'https://example.com/article2',
        'https://example.com/article3'
    ];
    
    const processor = new BatchArticleProcessor();
    processor.processArticles(urls).catch(console.error);
}

module.exports = BatchArticleProcessor;