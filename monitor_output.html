
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å°”å¤«æ–‡ç« å¤„ç†ç³»ç»Ÿç›‘æ§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .control-panel {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .restart-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .restart-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .restart-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            box-shadow: none;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .status-card h3 {
            margin-bottom: 15px;
            color: #3498db;
            font-size: 1.2rem;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2c3e50;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #95a5a6;
        }
        .status-value {
            font-weight: bold;
            color: #ecf0f1;
        }
        .running {
            color: #2ecc71;
        }
        .stopped {
            color: #e74c3c;
        }
        .warning {
            color: #f39c12;
        }
        .url-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .url-item {
            background: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .url-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #2c3e50;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        .log-container {
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2c3e50;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .processing-card {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        .site-name {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
        }
        .current-url {
            font-size: 0.85rem;
            color: #95a5a6;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #0f3460;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            max-width: 500px;
            text-align: center;
        }
        .modal h3 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }
        .modal-btn.cancel {
            background: #7f8c8d;
            color: white;
        }
        .restart-status {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #2c3e50;
            border-radius: 8px;
        }
        .restart-status.active {
            display: block;
        }
        .status-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #34495e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒï¸ é«˜å°”å¤«æ–‡ç« å¤„ç†ç³»ç»Ÿç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
        </div>

        <div class="refresh-indicator">
            ä¸‹æ¬¡åˆ·æ–°: <span id="countdown">10</span>ç§’
        </div>

        <div class="control-panel">
            <button id="restart-btn" class="restart-btn" onclick="confirmRestart()">
                ğŸ”„ ä¸€é”®é‡å¯ç³»ç»Ÿ
            </button>
            <div id="restart-status" class="restart-status">
                <div id="status-messages"></div>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                <div class="status-item">
                    <span class="status-label">ç³»ç»ŸçŠ¶æ€:</span>
                    <span id="system-status" class="status-value loading">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">è¿è¡Œè¿›ç¨‹:</span>
                    <span id="process-count" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä»Šæ—¥æ–‡ç« :</span>
                    <span id="today-articles" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æœ€æ–°å¤„ç†:</span>
                    <span id="last-process" class="status-value">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3>âš™ï¸ æœåŠ¡çŠ¶æ€</h3>
                <div class="status-item">
                    <span class="status-label">WebæœåŠ¡å™¨:</span>
                    <span id="web-server-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ™ºèƒ½æ§åˆ¶å™¨:</span>
                    <span id="controller-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ‰¹å¤„ç†å™¨:</span>
                    <span id="batch-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">URLç”Ÿæˆ:</span>
                    <span id="url-generation-status" class="status-value">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3>ğŸŒ ç½‘ç«™æ–‡ç« ç»Ÿè®¡</h3>
                <div id="site-stats">
                    <p class="loading">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div class="status-card">
                <h3>ğŸ¤– AIæ£€æµ‹ç»Ÿè®¡</h3>
                <div id="ai-stats">
                    <p class="loading">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h3>ğŸŒ ä»£ç†æ± ç»Ÿè®¡</h3>
            <div id="proxy-stats">
                <p class="loading">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div class="status-card">
            <h3>ğŸ“ URLæ–‡ä»¶ç»Ÿè®¡</h3>
            <div class="url-grid" id="url-stats">
                <p class="loading">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div class="status-card">
            <h3>ğŸ”„ å¤„ç†è¿›åº¦</h3>
            <div id="processing-progress">
                <p style="text-align: center; color: #95a5a6;">å½“å‰æ²¡æœ‰å¤„ç†ä»»åŠ¡</p>
            </div>
        </div>

        <div class="status-card">
            <h3>ğŸ“ æœ€æ–°æ—¥å¿—</h3>
            <div class="log-container" id="latest-logs">
                <span class="loading">ç­‰å¾…æ—¥å¿—æ•°æ®...</span>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤é‡å¯å¯¹è¯æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ç¡®è®¤é‡å¯ç³»ç»Ÿ</h3>
            <p>ç¡®å®šè¦é‡å¯æ•´ä¸ªé«˜å°”å¤«æ–‡ç« å¤„ç†ç³»ç»Ÿå—ï¼Ÿ</p>
            <p style="margin-top: 10px; color: #95a5a6; font-size: 0.9rem;">
                è¿™å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š<br>
                1. åœæ­¢æ‰€æœ‰å¤„ç†è¿›ç¨‹<br>
                2. é‡æ–°æŠ“å–7ä¸ªç½‘ç«™çš„æœ€æ–°URL<br>
                3. å¯åŠ¨æ™ºèƒ½å¹¶å‘æ§åˆ¶å™¨å¤„ç†æ–°æ–‡ç« 
            </p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="executeRestart()">ç¡®è®¤é‡å¯</button>
            </div>
        </div>
    </div>

    <script>
        let countdown = 10;
        const countdownElement = document.getElementById('countdown');
        let updateInterval;

        // å€’è®¡æ—¶
        const countdownInterval = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            if (countdown <= 0) {
                countdown = 10;
                updateStatus();
            }
        }, 1000);

        // è·å–ç³»ç»ŸçŠ¶æ€
        async function updateStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();

                // æ›´æ–°ç³»ç»Ÿæ¦‚è§ˆ
                document.getElementById('system-status').textContent = data.running ? 'æ­£å¸¸è¿è¡Œ' : 'å·²åœæ­¢';
                document.getElementById('system-status').className = data.running ? 'status-value running' : 'status-value stopped';
                document.getElementById('process-count').textContent = data.processCount + 'ä¸ª';
                document.getElementById('today-articles').textContent = data.todayArticles + 'ç¯‡';
                document.getElementById('last-process').textContent = data.lastProcessTime || '-';

                // æ›´æ–°æœåŠ¡çŠ¶æ€
                document.getElementById('web-server-status').textContent = data.services.webServer ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('web-server-status').className = data.services.webServer ? 'status-value running' : 'status-value stopped';
                document.getElementById('controller-status').textContent = data.services.controller ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('controller-status').className = data.services.controller ? 'status-value running' : 'status-value stopped';
                document.getElementById('batch-status').textContent = data.services.batchProcessor ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('batch-status').className = data.services.batchProcessor ? 'status-value running' : 'status-value stopped';
                document.getElementById('url-generation-status').textContent = data.urlGenerationRunning ? 'ç”Ÿæˆä¸­' : 'ç©ºé—²';
                document.getElementById('url-generation-status').className = data.urlGenerationRunning ? 'status-value warning' : 'status-value';

                // æ›´æ–°ç½‘ç«™ç»Ÿè®¡
                const siteStatsDiv = document.getElementById('site-stats');
                siteStatsDiv.innerHTML = '';
                if (data.siteStats) {
                    Object.entries(data.siteStats).forEach(([site, count]) => {
                        siteStatsDiv.innerHTML += `
                            <div class="status-item">
                                <span class="status-label">${site}:</span>
                                <span class="status-value">${count}ç¯‡</span>
                            </div>
                        `;
                    });
                }

                // æ›´æ–°AIæ£€æµ‹ç»Ÿè®¡
                const aiStatsDiv = document.getElementById('ai-stats');
                aiStatsDiv.innerHTML = '';
                if (data.aiStats) {
                    const stats = data.aiStats;
                    const detectionRate = stats.total > 0 ? ((stats.detected / stats.total) * 100).toFixed(1) : 0;
                    
                    aiStatsDiv.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">æ£€æµ‹å®Œæˆç‡:</span>
                            <span class="status-value">${detectionRate}% (${stats.detected}/${stats.total})</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¹³å‡AIæ¦‚ç‡:</span>
                            <span class="status-value">${stats.avgProbability || 0}%</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">é«˜é£é™©(â‰¥80%):</span>
                            <span class="status-value" style="color: #e74c3c;">${stats.highRisk}ç¯‡</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¸­é£é™©(50-79%):</span>
                            <span class="status-value" style="color: #f39c12;">${stats.mediumRisk}ç¯‡</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä½é£é™©(&lt;50%):</span>
                            <span class="status-value" style="color: #2ecc71;">${stats.lowRisk}ç¯‡</span>
                        </div>
                    `;
                } else {
                    aiStatsDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">æš‚æ— AIæ£€æµ‹æ•°æ®</p>';
                }

                // æ›´æ–°ä»£ç†ç»Ÿè®¡
                const proxyStatsDiv = document.getElementById('proxy-stats');
                proxyStatsDiv.innerHTML = '';
                if (data.proxyStats) {
                    const stats = data.proxyStats;
                    proxyStatsDiv.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">æ€»ä»£ç†æ•°:</span>
                            <span class="status-value">${stats.totalProxies}ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¥åº·ä»£ç†:</span>
                            <span class="status-value" style="color: #2ecc71;">${stats.healthyProxies}ä¸ª</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä»Šæ—¥æ€»é…é¢:</span>
                            <span class="status-value">${stats.totalQuotaToday}æ¬¡</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä»Šæ—¥å·²ç”¨:</span>
                            <span class="status-value">${stats.usedQuotaToday}æ¬¡</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä»Šæ—¥å‰©ä½™:</span>
                            <span class="status-value" style="color: ${stats.remainingQuotaToday > 50 ? '#2ecc71' : (stats.remainingQuotaToday > 20 ? '#f39c12' : '#e74c3c')};">${stats.remainingQuotaToday}æ¬¡</span>
                        </div>
                    `;
                    
                    // æ·»åŠ è¯¦ç»†ä¿¡æ¯ï¼ˆæŠ˜å å±•ç¤ºï¼‰
                    if (stats.proxyDetails && stats.proxyDetails.length > 0) {
                        proxyStatsDiv.innerHTML += `
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #3498db;">æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</summary>
                                <div style="margin-top: 10px;">
                                    ${stats.proxyDetails.map(proxy => `
                                        <div class="status-item" style="font-size: 0.85rem;">
                                            <span class="status-label">${proxy.name}:</span>
                                            <span class="status-value">
                                                ${proxy.usedToday}/${proxy.dailyLimit} 
                                                ${proxy.isHealthy ? '<span style="color: #2ecc71;">âœ…</span>' : '<span style="color: #e74c3c;">âŒ</span>'}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        `;
                    }
                } else {
                    proxyStatsDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">æš‚æ— ä»£ç†ç»Ÿè®¡æ•°æ®</p>';
                }

                // æ›´æ–°URLç»Ÿè®¡
                const urlStatsDiv = document.getElementById('url-stats');
                urlStatsDiv.innerHTML = '';
                if (data.urlStats) {
                    Object.entries(data.urlStats).forEach(([site, count]) => {
                        urlStatsDiv.innerHTML += `
                            <div class="url-item">
                                <div style="font-size: 0.9rem; color: #95a5a6;">${site}</div>
                                <div class="url-count">${count}</div>
                            </div>
                        `;
                    });
                }

                // æ›´æ–°å¤„ç†è¿›åº¦
                const progressDiv = document.getElementById('processing-progress');
                progressDiv.innerHTML = '';
                if (data.processingStatus && data.processingStatus.length > 0) {
                    data.processingStatus.forEach(item => {
                        const progress = item.total > 0 ? (item.processed / item.total * 100).toFixed(1) : 0;
                        progressDiv.innerHTML += `
                            <div class="processing-card">
                                <div class="site-name">${item.name}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%">
                                        ${item.processed}/${item.total} (${progress}%)
                                    </div>
                                </div>
                                <div class="current-url">${item.current || 'å‡†å¤‡ä¸­...'}</div>
                            </div>
                        `;
                    });
                } else if (data.urlGenerationRunning) {
                    progressDiv.innerHTML = '<p style="text-align: center; color: #f39c12;">æ­£åœ¨ç”ŸæˆURL...</p>';
                } else {
                    progressDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">å½“å‰æ²¡æœ‰å¤„ç†ä»»åŠ¡</p>';
                }

                // æ›´æ–°æ—¥å¿—
                document.getElementById('latest-logs').textContent = data.latestLogs || 'æš‚æ— æ—¥å¿—';

            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('system-status').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('system-status').className = 'status-value stopped';
            }
        }

        // ç¡®è®¤é‡å¯
        function confirmRestart() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // æ‰§è¡Œé‡å¯
        async function executeRestart() {
            closeModal();
            const btn = document.getElementById('restart-btn');
            const statusDiv = document.getElementById('restart-status');
            const messagesDiv = document.getElementById('status-messages');
            
            btn.disabled = true;
            btn.textContent = 'é‡å¯ä¸­...';
            statusDiv.classList.add('active');
            messagesDiv.innerHTML = '';

            // æ·»åŠ çŠ¶æ€æ¶ˆæ¯
            function addStatusMessage(message, type = 'info') {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'status-message';
                msgDiv.textContent = message;
                msgDiv.style.color = type === 'error' ? '#e74c3c' : (type === 'success' ? '#2ecc71' : '#3498db');
                messagesDiv.appendChild(msgDiv);
            }

            try {
                addStatusMessage('ğŸ”„ å¼€å§‹é‡å¯ç³»ç»Ÿ...');
                
                const response = await fetch('/api/restart-system', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addStatusMessage('âœ… ' + data.message);
                    
                    // ç›‘æ§é‡å¯è¿›åº¦
                    let checkCount = 0;
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        
                        if (checkCount === 2) addStatusMessage('â¹ï¸ æ­£åœ¨åœæ­¢ç°æœ‰è¿›ç¨‹...');
                        if (checkCount === 4) addStatusMessage('ğŸ” æ­£åœ¨ç”Ÿæˆæ–°URL...');
                        if (checkCount === 10) addStatusMessage('ğŸš€ æ­£åœ¨å¯åŠ¨å¤„ç†å™¨...');
                        
                        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                        await updateStatus();
                        
                        // 30ç§’åè®¤ä¸ºé‡å¯å®Œæˆ
                        if (checkCount >= 30) {
                            clearInterval(checkInterval);
                            addStatusMessage('âœ… ç³»ç»Ÿé‡å¯å®Œæˆï¼', 'success');
                            setTimeout(() => {
                                statusDiv.classList.remove('active');
                                btn.disabled = false;
                                btn.textContent = 'ğŸ”„ ä¸€é”®é‡å¯ç³»ç»Ÿ';
                            }, 3000);
                        }
                    }, 1000);
                    
                } else {
                    addStatusMessage('âŒ é‡å¯å¤±è´¥: ' + data.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”„ ä¸€é”®é‡å¯ç³»ç»Ÿ';
                }
            } catch (error) {
                addStatusMessage('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ä¸€é”®é‡å¯ç³»ç»Ÿ';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // é¡µé¢åŠ è½½æ—¶ç«‹å³æ›´æ–°
        updateStatus();

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                countdown = 10;
                updateStatus();
            }
        });
    </script>
</body>
</html>