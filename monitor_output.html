
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高尔夫文章处理系统监控</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .control-panel {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .restart-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .restart-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .restart-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            box-shadow: none;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .status-card h3 {
            margin-bottom: 15px;
            color: #3498db;
            font-size: 1.2rem;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2c3e50;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #95a5a6;
        }
        .status-value {
            font-weight: bold;
            color: #ecf0f1;
        }
        .running {
            color: #2ecc71;
        }
        .stopped {
            color: #e74c3c;
        }
        .warning {
            color: #f39c12;
        }
        .url-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .url-item {
            background: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .url-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #2c3e50;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        .log-container {
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2c3e50;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .processing-card {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        .site-name {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
        }
        .current-url {
            font-size: 0.85rem;
            color: #95a5a6;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #0f3460;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            max-width: 500px;
            text-align: center;
        }
        .modal h3 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }
        .modal-btn.cancel {
            background: #7f8c8d;
            color: white;
        }
        .restart-status {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #2c3e50;
            border-radius: 8px;
        }
        .restart-status.active {
            display: block;
        }
        .status-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #34495e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏌️ 高尔夫文章处理系统监控</h1>
            <p>实时监控系统运行状态</p>
        </div>

        <div class="refresh-indicator">
            下次刷新: <span id="countdown">10</span>秒
        </div>

        <div class="control-panel">
            <button id="restart-btn" class="restart-btn" onclick="confirmRestart()">
                🔄 一键重启系统
            </button>
            <div id="restart-status" class="restart-status">
                <div id="status-messages"></div>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>📊 系统概览</h3>
                <div class="status-item">
                    <span class="status-label">系统状态:</span>
                    <span id="system-status" class="status-value loading">检查中...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">运行进程:</span>
                    <span id="process-count" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">今日文章:</span>
                    <span id="today-articles" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">最新处理:</span>
                    <span id="last-process" class="status-value">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3>⚙️ 服务状态</h3>
                <div class="status-item">
                    <span class="status-label">Web服务器:</span>
                    <span id="web-server-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">智能控制器:</span>
                    <span id="controller-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">批处理器:</span>
                    <span id="batch-status" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">URL生成:</span>
                    <span id="url-generation-status" class="status-value">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3>🌐 网站文章统计</h3>
                <div id="site-stats">
                    <p class="loading">加载中...</p>
                </div>
            </div>

            <div class="status-card">
                <h3>🤖 AI检测统计</h3>
                <div id="ai-stats">
                    <p class="loading">加载中...</p>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h3>🌐 代理池统计</h3>
            <div id="proxy-stats">
                <p class="loading">加载中...</p>
            </div>
        </div>

        <div class="status-card">
            <h3>📁 URL文件统计</h3>
            <div class="url-grid" id="url-stats">
                <p class="loading">加载中...</p>
            </div>
        </div>

        <div class="status-card">
            <h3>🔄 处理进度</h3>
            <div id="processing-progress">
                <p style="text-align: center; color: #95a5a6;">当前没有处理任务</p>
            </div>
        </div>

        <div class="status-card">
            <h3>📝 最新日志</h3>
            <div class="log-container" id="latest-logs">
                <span class="loading">等待日志数据...</span>
            </div>
        </div>
    </div>

    <!-- 确认重启对话框 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>⚠️ 确认重启系统</h3>
            <p>确定要重启整个高尔夫文章处理系统吗？</p>
            <p style="margin-top: 10px; color: #95a5a6; font-size: 0.9rem;">
                这将执行以下操作：<br>
                1. 停止所有处理进程<br>
                2. 重新抓取7个网站的最新URL<br>
                3. 启动智能并发控制器处理新文章
            </p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="executeRestart()">确认重启</button>
            </div>
        </div>
    </div>

    <script>
        let countdown = 10;
        const countdownElement = document.getElementById('countdown');
        let updateInterval;

        // 倒计时
        const countdownInterval = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            if (countdown <= 0) {
                countdown = 10;
                updateStatus();
            }
        }, 1000);

        // 获取系统状态
        async function updateStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();

                // 更新系统概览
                document.getElementById('system-status').textContent = data.running ? '正常运行' : '已停止';
                document.getElementById('system-status').className = data.running ? 'status-value running' : 'status-value stopped';
                document.getElementById('process-count').textContent = data.processCount + '个';
                document.getElementById('today-articles').textContent = data.todayArticles + '篇';
                document.getElementById('last-process').textContent = data.lastProcessTime || '-';

                // 更新服务状态
                document.getElementById('web-server-status').textContent = data.services.webServer ? '运行中' : '已停止';
                document.getElementById('web-server-status').className = data.services.webServer ? 'status-value running' : 'status-value stopped';
                document.getElementById('controller-status').textContent = data.services.controller ? '运行中' : '已停止';
                document.getElementById('controller-status').className = data.services.controller ? 'status-value running' : 'status-value stopped';
                document.getElementById('batch-status').textContent = data.services.batchProcessor ? '运行中' : '已停止';
                document.getElementById('batch-status').className = data.services.batchProcessor ? 'status-value running' : 'status-value stopped';
                document.getElementById('url-generation-status').textContent = data.urlGenerationRunning ? '生成中' : '空闲';
                document.getElementById('url-generation-status').className = data.urlGenerationRunning ? 'status-value warning' : 'status-value';

                // 更新网站统计
                const siteStatsDiv = document.getElementById('site-stats');
                siteStatsDiv.innerHTML = '';
                if (data.siteStats) {
                    Object.entries(data.siteStats).forEach(([site, count]) => {
                        siteStatsDiv.innerHTML += `
                            <div class="status-item">
                                <span class="status-label">${site}:</span>
                                <span class="status-value">${count}篇</span>
                            </div>
                        `;
                    });
                }

                // 更新AI检测统计
                const aiStatsDiv = document.getElementById('ai-stats');
                aiStatsDiv.innerHTML = '';
                if (data.aiStats) {
                    const stats = data.aiStats;
                    const detectionRate = stats.total > 0 ? ((stats.detected / stats.total) * 100).toFixed(1) : 0;
                    
                    aiStatsDiv.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">检测完成率:</span>
                            <span class="status-value">${detectionRate}% (${stats.detected}/${stats.total})</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">平均AI概率:</span>
                            <span class="status-value">${stats.avgProbability || 0}%</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">高风险(≥80%):</span>
                            <span class="status-value" style="color: #e74c3c;">${stats.highRisk}篇</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">中风险(50-79%):</span>
                            <span class="status-value" style="color: #f39c12;">${stats.mediumRisk}篇</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">低风险(&lt;50%):</span>
                            <span class="status-value" style="color: #2ecc71;">${stats.lowRisk}篇</span>
                        </div>
                    `;
                } else {
                    aiStatsDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">暂无AI检测数据</p>';
                }

                // 更新代理统计
                const proxyStatsDiv = document.getElementById('proxy-stats');
                proxyStatsDiv.innerHTML = '';
                if (data.proxyStats) {
                    const stats = data.proxyStats;
                    proxyStatsDiv.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">总代理数:</span>
                            <span class="status-value">${stats.totalProxies}个</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">健康代理:</span>
                            <span class="status-value" style="color: #2ecc71;">${stats.healthyProxies}个</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">今日总配额:</span>
                            <span class="status-value">${stats.totalQuotaToday}次</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">今日已用:</span>
                            <span class="status-value">${stats.usedQuotaToday}次</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">今日剩余:</span>
                            <span class="status-value" style="color: ${stats.remainingQuotaToday > 50 ? '#2ecc71' : (stats.remainingQuotaToday > 20 ? '#f39c12' : '#e74c3c')};">${stats.remainingQuotaToday}次</span>
                        </div>
                    `;
                    
                    // 添加详细信息（折叠展示）
                    if (stats.proxyDetails && stats.proxyDetails.length > 0) {
                        proxyStatsDiv.innerHTML += `
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #3498db;">查看详细信息</summary>
                                <div style="margin-top: 10px;">
                                    ${stats.proxyDetails.map(proxy => `
                                        <div class="status-item" style="font-size: 0.85rem;">
                                            <span class="status-label">${proxy.name}:</span>
                                            <span class="status-value">
                                                ${proxy.usedToday}/${proxy.dailyLimit} 
                                                ${proxy.isHealthy ? '<span style="color: #2ecc71;">✅</span>' : '<span style="color: #e74c3c;">❌</span>'}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        `;
                    }
                } else {
                    proxyStatsDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">暂无代理统计数据</p>';
                }

                // 更新URL统计
                const urlStatsDiv = document.getElementById('url-stats');
                urlStatsDiv.innerHTML = '';
                if (data.urlStats) {
                    Object.entries(data.urlStats).forEach(([site, count]) => {
                        urlStatsDiv.innerHTML += `
                            <div class="url-item">
                                <div style="font-size: 0.9rem; color: #95a5a6;">${site}</div>
                                <div class="url-count">${count}</div>
                            </div>
                        `;
                    });
                }

                // 更新处理进度
                const progressDiv = document.getElementById('processing-progress');
                progressDiv.innerHTML = '';
                if (data.processingStatus && data.processingStatus.length > 0) {
                    data.processingStatus.forEach(item => {
                        const progress = item.total > 0 ? (item.processed / item.total * 100).toFixed(1) : 0;
                        progressDiv.innerHTML += `
                            <div class="processing-card">
                                <div class="site-name">${item.name}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%">
                                        ${item.processed}/${item.total} (${progress}%)
                                    </div>
                                </div>
                                <div class="current-url">${item.current || '准备中...'}</div>
                            </div>
                        `;
                    });
                } else if (data.urlGenerationRunning) {
                    progressDiv.innerHTML = '<p style="text-align: center; color: #f39c12;">正在生成URL...</p>';
                } else {
                    progressDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">当前没有处理任务</p>';
                }

                // 更新日志
                document.getElementById('latest-logs').textContent = data.latestLogs || '暂无日志';

            } catch (error) {
                console.error('获取状态失败:', error);
                document.getElementById('system-status').textContent = '连接失败';
                document.getElementById('system-status').className = 'status-value stopped';
            }
        }

        // 确认重启
        function confirmRestart() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // 执行重启
        async function executeRestart() {
            closeModal();
            const btn = document.getElementById('restart-btn');
            const statusDiv = document.getElementById('restart-status');
            const messagesDiv = document.getElementById('status-messages');
            
            btn.disabled = true;
            btn.textContent = '重启中...';
            statusDiv.classList.add('active');
            messagesDiv.innerHTML = '';

            // 添加状态消息
            function addStatusMessage(message, type = 'info') {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'status-message';
                msgDiv.textContent = message;
                msgDiv.style.color = type === 'error' ? '#e74c3c' : (type === 'success' ? '#2ecc71' : '#3498db');
                messagesDiv.appendChild(msgDiv);
            }

            try {
                addStatusMessage('🔄 开始重启系统...');
                
                const response = await fetch('/api/restart-system', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addStatusMessage('✅ ' + data.message);
                    
                    // 监控重启进度
                    let checkCount = 0;
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        
                        if (checkCount === 2) addStatusMessage('⏹️ 正在停止现有进程...');
                        if (checkCount === 4) addStatusMessage('🔍 正在生成新URL...');
                        if (checkCount === 10) addStatusMessage('🚀 正在启动处理器...');
                        
                        // 更新系统状态
                        await updateStatus();
                        
                        // 30秒后认为重启完成
                        if (checkCount >= 30) {
                            clearInterval(checkInterval);
                            addStatusMessage('✅ 系统重启完成！', 'success');
                            setTimeout(() => {
                                statusDiv.classList.remove('active');
                                btn.disabled = false;
                                btn.textContent = '🔄 一键重启系统';
                            }, 3000);
                        }
                    }, 1000);
                    
                } else {
                    addStatusMessage('❌ 重启失败: ' + data.message, 'error');
                    btn.disabled = false;
                    btn.textContent = '🔄 一键重启系统';
                }
            } catch (error) {
                addStatusMessage('❌ 请求失败: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = '🔄 一键重启系统';
            }
        }

        // 点击模态框外部关闭
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // 页面加载时立即更新
        updateStatus();

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                countdown = 10;
                updateStatus();
            }
        });
    </script>
</body>
</html>