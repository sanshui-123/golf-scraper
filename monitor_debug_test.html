<!DOCTYPE html>
<html>
<head>
    <title>ç›‘æ§é¡µé¢è°ƒè¯•</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status-grid { border: 2px solid red; padding: 20px; min-height: 200px; background: #f9f9f9; }
        .status-card { background: #fff; padding: 10px; margin: 10px 0; border: 1px solid #ddd; }
        pre { background: #333; color: #fff; padding: 10px; overflow: auto; height: 400px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ç›‘æ§é¡µé¢è°ƒè¯•æµ‹è¯•</h1>
    
    <button onclick="fetchAndDisplay()">è·å–å¹¶æ˜¾ç¤ºç½‘ç«™çŠ¶æ€</button>
    <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
    <button onclick="window.open('http://localhost:8080', '_blank')">Webä¸»é¡µ</button>
    <button onclick="window.open('http://localhost:8080/monitor', '_blank')">ç›‘æ§é¡µé¢</button>
    
    <h2>status-gridå®¹å™¨:</h2>
    <div class="status-grid">
        <div class="status-card">
            <h3>ğŸ“¦ é»˜è®¤å¡ç‰‡</h3>
            <p>è¿™æ˜¯ä¸€ä¸ªé»˜è®¤çš„status-card</p>
        </div>
    </div>
    
    <h2>æ§åˆ¶å°è¾“å‡º:</h2>
    <pre id="console"></pre>
    
    <script>
        const consoleDiv = document.getElementById('console');
        
        function log(msg) {
            const time = new Date().toISOString().substr(11,8);
            consoleDiv.innerHTML += time + ' ' + msg + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
            log('æ§åˆ¶å°å·²æ¸…ç©º');
        }
        
        async function fetchAndDisplay() {
            try {
                log('=== å¼€å§‹è·å–ç³»ç»ŸçŠ¶æ€ ===');
                const response = await fetch('/api/system-status');
                const data = await response.json();
                
                log('APIå“åº”çŠ¶æ€: ' + response.status);
                log('APIè¿”å›æ•°æ®å­—æ®µ:');
                log('  - running: ' + data.running);
                log('  - processCount: ' + data.processCount);
                log('  - todayArticles: ' + data.todayArticles);
                log('  - websites: ' + (data.websites ? data.websites.length + 'ä¸ª' : 'æ— '));
                
                // æ˜¾ç¤ºç½‘ç«™è¯¦ç»†çŠ¶æ€
                log('\n=== å¼€å§‹æ¸²æŸ“ç½‘ç«™çŠ¶æ€ ===');
                if (data.websites && data.websites.length > 0) {
                    log('æ‰¾åˆ° ' + data.websites.length + ' ä¸ªç½‘ç«™ï¼Œå‡†å¤‡æ¸²æŸ“...');
                    
                    // å…ˆç§»é™¤å·²å­˜åœ¨çš„ç½‘ç«™çŠ¶æ€å¡ç‰‡
                    const existingWebsiteStatus = document.getElementById('website-status-card');
                    if (existingWebsiteStatus) {
                        existingWebsiteStatus.remove();
                        log('å·²ç§»é™¤æ—§çš„ç½‘ç«™çŠ¶æ€å¡ç‰‡');
                    }
                    
                    const websiteStatusDiv = document.createElement('div');
                    websiteStatusDiv.id = 'website-status-card';
                    websiteStatusDiv.className = 'status-card';
                    websiteStatusDiv.style.marginTop = '20px';
                    websiteStatusDiv.style.background = '#e3f2fd';
                    websiteStatusDiv.innerHTML = '<h3>ğŸŒ ç½‘ç«™å¤„ç†çŠ¶æ€</h3>';
                    log('åˆ›å»ºæ–°çš„ç½‘ç«™çŠ¶æ€å¡ç‰‡');
                    
                    const websiteGrid = document.createElement('div');
                    websiteGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;';
                    
                    // æ˜¾ç¤ºæ‰€æœ‰ç½‘ç«™
                    log('\nç½‘ç«™è¯¦æƒ…:');
                    data.websites.forEach((site, index) => {
                        log('\nç½‘ç«™ ' + (index + 1) + ': ' + site.name);
                        log('  - URLæ–‡ä»¶: ' + site.urlFile);
                        log('  - çŠ¶æ€: ' + site.status + ' (' + site.statusText + ')');
                        log('  - URLæ€»æ•°: ' + site.totalUrls);
                        log('  - å¾…å¤„ç†: ' + site.pendingUrls);
                        log('  - å·²å¤„ç†: ' + site.processedUrls);
                        log('  - ä»Šæ—¥æ–‡ç« : ' + site.articlesToday);
                        
                        const siteCard = document.createElement('div');
                        siteCard.style.cssText = 'background: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc;';
                        
                        const detailStats = site.detailStats || {};
                        log('  - è¯¦ç»†ç»Ÿè®¡: ' + JSON.stringify(detailStats));
                        
                        const totalProcessed = detailStats.processed || 0;
                        
                        // åˆ›å»ºçŠ¶æ€å¾½ç« 
                        const badges = [];
                        if (detailStats.success > 0) badges.push(`<span style="color: green;">âœ… æˆåŠŸ:${detailStats.success}</span>`);
                        if (detailStats.failed > 0) badges.push(`<span style="color: red;">âŒ å¤±è´¥:${detailStats.failed}</span>`);
                        if (detailStats.skipped > 0) badges.push(`<span style="color: orange;">â­ï¸ è·³è¿‡:${detailStats.skipped}</span>`);
                        if (detailStats.duplicate > 0) badges.push(`<span style="color: purple;">ğŸ” é‡å¤:${detailStats.duplicate}</span>`);
                        if (detailStats.pending > 0) badges.push(`<span style="color: blue;">â³ å¾…å¤„ç†:${detailStats.pending}</span>`);
                        
                        siteCard.innerHTML = `
                            <div style="font-weight: bold; font-size: 1rem; margin-bottom: 5px;">
                                ${site.statusIcon || 'ğŸ“„'} ${site.name}
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                                æ€»è®¡: ${site.totalUrls || 0} | å·²å¤„ç†: ${totalProcessed}
                            </div>
                            <div style="font-size: 0.8rem; line-height: 1.5;">
                                ${badges.join(' ')}
                            </div>
                        `;
                        
                        websiteGrid.appendChild(siteCard);
                    });
                    
                    websiteStatusDiv.appendChild(websiteGrid);
                    
                    // æ·»åŠ åˆ°status-gridå®¹å™¨
                    const statusGrid = document.querySelector('.status-grid');
                    log('\næŸ¥æ‰¾status-gridå®¹å™¨...');
                    if (statusGrid) {
                        statusGrid.appendChild(websiteStatusDiv);
                        log('âœ… æˆåŠŸæ·»åŠ ç½‘ç«™çŠ¶æ€å¡ç‰‡åˆ°status-gridå®¹å™¨');
                        log('å½“å‰status-gridå­å…ƒç´ æ•°é‡: ' + statusGrid.children.length);
                    } else {
                        log('âŒ é”™è¯¯: æ‰¾ä¸åˆ°status-gridå®¹å™¨!');
                    }
                } else {
                    log('âš ï¸ æ²¡æœ‰websitesæ•°æ®æˆ–ä¸ºç©ºæ•°ç»„');
                    log('data.websites = ' + JSON.stringify(data.websites));
                }
                
                log('\n=== å®Œæˆ ===');
                
            } catch (error) {
                log('\nâŒ é”™è¯¯: ' + error.message);
                log('å †æ ˆè·Ÿè¸ª:');
                log(error.stack);
            }
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log('å½“å‰æ—¶é—´: ' + new Date().toLocaleString());
            log('\nè‡ªåŠ¨è·å–æ•°æ®...');
            fetchAndDisplay();
        };
    </script>
</body>
</html>