# URL新鲜度解决方案 (2025-08-22)

## 问题背景
用户发现点击"▶️ 继续处理URL"后，系统在中午时段（11:54-11:55）已经重新生成了URL文件，导致处理了许多重复文章。需要防止不必要的URL重新生成。

## 解决方案概述
1. **创建专用脚本**：分离"重启系统"和"继续处理"的逻辑
2. **添加新鲜度检查**：在Web监控面板显示URL文件的更新时间
3. **提供工具脚本**：便于用户检查和管理URL文件状态

## 实现的功能

### 1. URL新鲜度检查脚本
**文件**: `check_url_freshness.sh`
- 检查所有URL文件的修改时间
- 显示每个文件的年龄（小时和分钟）
- 标记超过6小时的文件为"过期"
- 给出操作建议

### 2. 智能继续处理脚本
**文件**: `smart_continue.sh`
- 不重新生成URL，直接处理现有文件
- 检查是否有URL文件存在
- 自动启动Web服务器（如需要）
- 检测是否已有处理进程在运行

### 3. 停止处理器脚本
**文件**: `stop_processors.sh`
- 只停止处理进程，保留Web服务器
- 显示要停止的进程列表
- 支持强制终止残留进程

### 4. Web监控面板增强
**更新**: `web_server.js`
- 在每个网站卡片上显示URL文件更新时间
- 过期文件（>6小时）显示红色警告
- 在顶部汇总区域显示过期文件数量

## 使用指南

### 日常操作流程
```bash
# 1. 检查URL文件新鲜度
./check_url_freshness.sh

# 2. 如果文件较新（<6小时），继续处理
./smart_continue.sh

# 3. 如果文件过期（>6小时），重新开始
./smart_restart.sh

# 4. 停止所有处理（保留Web服务器）
./stop_processors.sh
```

### Web监控面板
访问 http://localhost:8080/monitor 查看：
- 每个网站的URL文件更新时间
- 过期文件的红色警告提示
- 顶部汇总栏的过期文件统计

## 技术实现细节

### 后端改进
1. **collectSystemStatus函数**：
   - 读取每个URL文件时获取文件修改时间
   - 计算文件年龄并判断是否过期
   - 将fileAge信息添加到websiteData对象

2. **数据结构**：
```javascript
websiteData.fileAge = {
    hours: 4,                           // 小时数
    minutes: 32,                        // 分钟数
    timestamp: "2025-08-22T11:54:00Z", // ISO时间戳
    isStale: false,                     // 是否过期（>6小时）
    displayText: "4小时32分钟前"        // 显示文本
}
```

### 前端显示
1. **网站卡片**：在网站名称下方显示更新时间
2. **颜色编码**：
   - 正常（<6小时）：灰色 #95a5a6
   - 过期（>6小时）：红色 #e74c3c
3. **图标**：
   - 正常：🕐
   - 过期：⚠️

## 防止URL重复生成的关键点

1. **明确区分两种操作**：
   - "一键重启系统" → 重新生成URL
   - "继续处理URL" → 不生成URL

2. **提供清晰的用户指引**：
   - 脚本中的提示信息
   - Web界面的操作说明
   - 新鲜度检查建议

3. **避免意外触发**：
   - 无自动化任务（cron）
   - 脚本相互独立
   - 明确的操作确认

## 效果验证
- URL文件新鲜度实时显示
- 过期警告醒目可见
- 操作建议清晰明确
- 避免不必要的URL重新生成