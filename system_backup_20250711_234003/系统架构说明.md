# 高尔夫文章处理系统 - 系统架构说明

## 系统架构图

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   用户输入URL   │ --> │  批量处理器      │ --> │   Claude API    │
└─────────────────┘     │ batch_process_   │     └─────────────────┘
                        │ articles.js      │              |
                        └──────────────────┘              v
                                |                   ┌─────────────────┐
                                |                   │  改写后的内容   │
                                v                   └─────────────────┘
                        ┌──────────────────┐              |
                        │   图片处理器     │ <------------┘
                        │ image_processor_ │
                        │ final.js         │
                        └──────────────────┘
                                |
                                v
                        ┌──────────────────┐
                        │   文件存储       │
                        │  golf_content/   │
                        └──────────────────┘
                                |
                                v
                        ┌──────────────────┐
                        │   查看服务器     │
                        │  view_server.js  │
                        └──────────────────┘
                                |
                                v
                        ┌──────────────────┐
                        │   Web界面        │
                        │ localhost:8080   │
                        └──────────────────┘
```

## 核心模块详解

### 1. 批量处理器 (BatchArticleProcessor)
**文件**: `batch_process_articles.js`

**主要功能**:
- URL去重检测
- 浏览器自动化（Playwright）
- 并行抓取优化
- Claude API调用管理
- 文件生成和保存

**关键方法**:
```javascript
- processArticles(urls)      // 主处理流程
- fetchArticlesInParallel()  // 并行抓取
- rewriteWithClaude()       // Claude改写
- generateHTML()            // 生成HTML
```

### 2. 文章改写器 (ArticleRewriterEnhanced)
**文件**: `article_rewriter_enhanced.js`

**主要功能**:
- Claude API封装
- 流式响应处理
- 错误重试机制
- 响应验证

**关键配置**:
```javascript
- model: 'claude-3-5-sonnet-20241022'
- max_tokens: 8192
- temperature: 0.3
```

### 3. 图片处理器 (ImageProcessorFinal)
**文件**: `image_processor_final.js`

**主要功能**:
- 图片下载
- 路径管理
- 占位符替换
- 错误处理

### 4. 查看服务器 (ViewServer)
**文件**: `view_server.js`

**主要功能**:
- HTTP服务器
- 路由处理
- 文件服务
- API接口

**路由结构**:
```
/ - 首页（文章列表）
/view/:date/md/:file - Markdown查看
/view/:date/wechat/:file - 微信版查看
/delete/:date/:file - 删除文章
/*.jpg|png|gif - 图片服务
```

### 5. 重复检测器 (WebsiteDuplicateChecker)
**文件**: `website_duplicate_checker.js`

**主要功能**:
- 全局去重
- URL映射管理
- 历史记录

## 数据流程

### 1. 输入阶段
```
用户输入URL -> start.js -> BatchArticleProcessor
```

### 2. 处理阶段
```
URL列表 -> 去重检测 -> 并行抓取 -> Claude改写 -> 图片处理
```

### 3. 存储阶段
```
生成文件结构:
golf_content/
└── 2025-07-11/
    ├── articles/          # Markdown文章
    ├── images/           # 下载的图片
    ├── wechat_html/     # 微信版HTML
    ├── wechat_ready/    # 微信版Markdown
    └── article_urls.json # URL映射
```

### 4. 展示阶段
```
view_server.js -> HTTP服务 -> Web界面 -> 用户浏览
```

## 关键技术栈

### 后端
- **Node.js**: 运行环境
- **Playwright**: 浏览器自动化
- **Anthropic SDK**: Claude API调用

### 前端
- **原生HTML/CSS/JS**: 简洁高效
- **响应式设计**: 适配各种屏幕

### 存储
- **文件系统**: 直接文件存储
- **JSON**: 配置和映射数据

## 性能优化

### 1. 并行处理
- 多文章并行抓取
- 图片并行下载
- 减少总处理时间

### 2. 缓存机制
- 去重检测避免重复处理
- 本地图片存储减少网络请求

### 3. 流式处理
- Claude API流式响应
- 实时显示处理进度

## 安全考虑

### 1. API密钥
- 使用环境变量存储
- 不在代码中硬编码

### 2. 文件访问
- 限制在特定目录
- 路径验证

### 3. 输入验证
- URL格式验证
- 文件名安全处理

## 扩展性设计

### 1. 模块化架构
- 各模块独立
- 易于维护和扩展

### 2. 配置化
- 网站配置可扩展
- 提示词可定制

### 3. 接口设计
- 清晰的模块接口
- 便于添加新功能